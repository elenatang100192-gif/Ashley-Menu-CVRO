<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quick Migrate: Firestore to MySQL</title>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; max-width: 900px; margin: 0 auto; }
        .section { margin: 20px 0; padding: 15px; border: 1px solid #ddd; border-radius: 5px; }
        button { padding: 10px 20px; margin: 5px; cursor: pointer; background: #4CAF50; color: white; border: none; border-radius: 5px; }
        button:hover { background: #45a049; }
        button:disabled { background: #ccc; cursor: not-allowed; }
        .success { color: green; }
        .error { color: red; }
        .info { background: #e7f3ff; padding: 10px; border-radius: 5px; }
        pre { background: #f5f5f5; padding: 10px; overflow-x: auto; max-height: 200px; overflow-y: auto; }
    </style>
</head>
<body>
    <h1>ğŸš€ Quick Migrate: Firestore to MySQL</h1>
    
    <div class="section info">
        <h2>Instructions</h2>
        <ol>
            <li><strong>é‡è¦ï¼š</strong>è¯·é€šè¿‡ HTTP æœåŠ¡å™¨è®¿é—®æ­¤é¡µé¢ï¼Œä¸è¦ç›´æ¥æ‰“å¼€æ–‡ä»¶</li>
            <li>ç¡®ä¿ API æœåŠ¡å™¨æ­£åœ¨è¿è¡Œ: <code>node api-server.js</code></li>
            <li>åœ¨æµè§ˆå™¨ä¸­è®¿é—®: <code>http://localhost:3000/quick-migrate.html</code></li>
            <li>ç‚¹å‡» "Start Migration" æŒ‰é’®å¼€å§‹è¿ç§»</li>
            <li>ç­‰å¾…è¿ç§»å®Œæˆ</li>
            <li>åœ¨åº”ç”¨ä¸­éªŒè¯æ•°æ®</li>
        </ol>
        <p style="color: red; font-weight: bold;">
            âš ï¸ å¦‚æœç›´æ¥æ‰“å¼€æ–‡ä»¶ï¼ˆfile://ï¼‰ï¼ŒAPI è¯·æ±‚ä¼šå¤±è´¥ã€‚è¯·ä½¿ç”¨ http://localhost:3000/quick-migrate.html
        </p>
    </div>
    
    <div class="section">
        <h2>Migration Status</h2>
        <button id="migrateBtn" onclick="startMigration()">Start Migration</button>
        <div id="status"></div>
    </div>
    
    <div class="section">
        <h2>Migration Log</h2>
        <pre id="log"></pre>
    </div>
    
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    <script src="firebase-config.js"></script>
    <script>
        const API_BASE = '/api';
        const log = document.getElementById('log');
        const status = document.getElementById('status');
        const migrateBtn = document.getElementById('migrateBtn');
        
        function addLog(message) {
            const time = new Date().toLocaleTimeString();
            log.textContent += `[${time}] ${message}\n`;
            log.scrollTop = log.scrollHeight;
            console.log(message);
        }
        
        async function apiRequest(endpoint, method = 'GET', data = null) {
            const url = `${API_BASE}${endpoint}`;
            const options = {
                method: method,
                headers: { 'Content-Type': 'application/json' }
            };
            if (data && (method === 'POST' || method === 'PUT')) {
                options.body = JSON.stringify(data);
            }
            try {
                const response = await fetch(url, options);
                if (!response.ok) {
                    const error = await response.json().catch(() => ({ error: `HTTP ${response.status}: ${response.statusText}` }));
                    throw new Error(error.error || error.message || `HTTP ${response.status}: ${response.statusText}`);
                }
                return await response.json();
            } catch (error) {
                // å¤„ç†ç½‘ç»œé”™è¯¯
                if (error.name === 'TypeError' && error.message.includes('fetch')) {
                    const currentUrl = window.location.href;
                    let errorMsg = `æ— æ³•è¿æ¥åˆ° API æœåŠ¡å™¨ (${url})ã€‚\n\n`;
                    
                    if (currentUrl.startsWith('file://')) {
                        errorMsg += 'âŒ é”™è¯¯ï¼šæ‚¨æ­£åœ¨ä½¿ç”¨ file:// åè®®æ‰“å¼€æ–‡ä»¶ã€‚\n\n';
                        errorMsg += 'âœ… è§£å†³æ–¹æ³•ï¼š\n';
                        errorMsg += '1. ç¡®ä¿ API æœåŠ¡å™¨æ­£åœ¨è¿è¡Œ: node api-server.js\n';
                        errorMsg += '2. åœ¨æµè§ˆå™¨ä¸­è®¿é—®: http://localhost:3000/quick-migrate.html\n';
                        errorMsg += '3. ä¸è¦ç›´æ¥åŒå‡»æ‰“å¼€ HTML æ–‡ä»¶';
                    } else {
                        errorMsg += 'è¯·ç¡®ä¿ï¼š\n';
                        errorMsg += '1. API æœåŠ¡å™¨æ­£åœ¨è¿è¡Œ: node api-server.js\n';
                        errorMsg += '2. è®¿é—®åœ°å€æ­£ç¡®: http://localhost:3000/quick-migrate.html';
                    }
                    
                    throw new Error(errorMsg);
                }
                throw error;
            }
        }
        
        async function startMigration() {
            migrateBtn.disabled = true;
            status.innerHTML = '<p>ğŸ”„ Migration in progress...</p>';
            log.textContent = '';
            
            try {
                addLog('ğŸ“‹ Starting Firestore to MySQL migration...');
                
                // Check Firebase connection
                if (typeof firebase === 'undefined' || !firebase.firestore) {
                    throw new Error('Firebase not loaded');
                }
                const db = firebase.firestore();
                addLog('âœ… Firebase connected');
                
                // Check API connection
                addLog('ğŸ”Œ Checking API server connection...');
                try {
                    await apiRequest('/health');
                    addLog('âœ… API server connected');
                } catch (error) {
                    addLog(`âŒ API server connection failed: ${error.message}`);
                    addLog('ğŸ’¡ è¯·ç¡®ä¿ API æœåŠ¡å™¨æ­£åœ¨è¿è¡Œ: node api-server.js');
                    throw error;
                }
                
                // Export Menu Items
                addLog('\nğŸ“‹ Exporting menu items from Firestore...');
                const menuSnapshot = await db.collection('menuItems').get();
                const menuItems = [];
                menuSnapshot.forEach(doc => {
                    const data = doc.data();
                    menuItems.push({
                        id: data.id,
                        category: data.category || null,
                        name: data.name || '',
                        tag: data.tag || null,
                        subtitle: data.subtitle || null,
                        description: data.description || null,
                        price: data.price || null,
                        image: data.image || null
                    });
                });
                addLog(`âœ… Found ${menuItems.length} menu items`);
                
                if (menuItems.length > 0) {
                    // First, clear all existing items
                    addLog('ğŸ—‘ï¸  Clearing existing menu items...');
                    await apiRequest('/menu-items', 'POST', { items: [], migration: false });
                    
                    // Batch upload to avoid payload too large error
                    const BATCH_SIZE = 10;
                    let migrated = 0;
                    for (let i = 0; i < menuItems.length; i += BATCH_SIZE) {
                        const batch = menuItems.slice(i, i + BATCH_SIZE);
                        await apiRequest('/menu-items?migration=true', 'POST', { items: batch, migration: true });
                        migrated += batch.length;
                        addLog(`âœ… Migrated ${migrated}/${menuItems.length} menu items...`);
                    }
                    addLog(`âœ… Migrated all ${menuItems.length} menu items to MySQL`);
                }
                
                // Export Orders
                addLog('\nğŸ“¦ Exporting orders from Firestore...');
                const ordersSnapshot = await db.collection('orders').get();
                const orders = [];
                ordersSnapshot.forEach(doc => {
                    const data = doc.data();
                    orders.push({
                        id: data.id,
                        name: data.name || '',
                        order: data.order || '',
                        items: data.items || [],
                        date: data.date || ''
                    });
                });
                addLog(`âœ… Found ${orders.length} orders`);
                
                if (orders.length > 0) {
                    // Batch upload to avoid payload too large error
                    const BATCH_SIZE = 50;
                    let migrated = 0;
                    for (let i = 0; i < orders.length; i += BATCH_SIZE) {
                        const batch = orders.slice(i, i + BATCH_SIZE);
                        await apiRequest('/orders/batch', 'POST', { orders: batch });
                        migrated += batch.length;
                        addLog(`âœ… Migrated ${migrated}/${orders.length} orders...`);
                    }
                    addLog(`âœ… Migrated all ${orders.length} orders to MySQL`);
                }
                
                // Export Settings
                addLog('\nâš™ï¸  Exporting settings from Firestore...');
                const settingsDoc = await db.collection('settings').doc('hiddenRestaurants').get();
                let hiddenRestaurants = [];
                if (settingsDoc.exists) {
                    const data = settingsDoc.data();
                    hiddenRestaurants = data.restaurants || [];
                }
                addLog(`âœ… Found ${hiddenRestaurants.length} hidden restaurants`);
                
                await apiRequest('/settings/hiddenRestaurants', 'PUT', { restaurants: hiddenRestaurants });
                addLog(`âœ… Migrated settings to MySQL`);
                
                addLog('\nâœ… Migration completed successfully!');
                addLog('\nğŸ“Š Summary:');
                addLog(`   - Menu Items: ${menuItems.length}`);
                addLog(`   - Orders: ${orders.length}`);
                addLog(`   - Hidden Restaurants: ${hiddenRestaurants.length}`);
                
                status.innerHTML = '<p class="success">âœ… Migration completed successfully!</p>';
                
            } catch (error) {
                addLog(`\nâŒ Migration failed: ${error.message}`);
                status.innerHTML = `<p class="error">âŒ Migration failed: ${error.message}</p>`;
            } finally {
                migrateBtn.disabled = false;
            }
        }
        
        // Auto-start migration on load
        window.addEventListener('load', () => {
            const currentUrl = window.location.href;
            if (currentUrl.startsWith('file://')) {
                addLog('âš ï¸  è­¦å‘Šï¼šæ£€æµ‹åˆ°ä½¿ç”¨ file:// åè®®æ‰“å¼€æ–‡ä»¶');
                addLog('âŒ è¿™ä¼šå¯¼è‡´ API è¯·æ±‚å¤±è´¥ï¼');
                addLog('');
                addLog('âœ… è¯·æŒ‰ä»¥ä¸‹æ­¥éª¤æ“ä½œï¼š');
                addLog('1. ç¡®ä¿ API æœåŠ¡å™¨æ­£åœ¨è¿è¡Œ: node api-server.js');
                addLog('2. åœ¨æµè§ˆå™¨åœ°å€æ è¾“å…¥: http://localhost:3000/quick-migrate.html');
                addLog('3. ä¸è¦ç›´æ¥åŒå‡»æ‰“å¼€ HTML æ–‡ä»¶');
                status.innerHTML = '<p class="error">âš ï¸ è¯·é€šè¿‡ HTTP æœåŠ¡å™¨è®¿é—®æ­¤é¡µé¢ï¼<br>è®¿é—®åœ°å€: <a href="http://localhost:3000/quick-migrate.html" target="_blank">http://localhost:3000/quick-migrate.html</a></p>';
            } else {
                addLog('âœ… é¡µé¢åŠ è½½å®Œæˆ');
                addLog('ğŸ“‹ å‡†å¤‡å°±ç»ªï¼Œç‚¹å‡» "Start Migration" å¼€å§‹è¿ç§»');
            }
        });
    </script>
</body>
</html>

